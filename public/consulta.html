<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Agendamento</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#5a6b5c">
    <style>
        /* Reset e Estilos */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            min-height: 100vh; padding: 20px; font-family: sans-serif; background-color: #f8f9fa;
        }
        h1 { color: #5a6b5c; margin-bottom: 10px; }
        p { color: #666; margin-bottom: 30px; }
        .busca-container { 
            width: 100%; max-width: 400px; background: white; padding: 30px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        input#placa-busca { 
            width: 100%; padding: 15px; font-size: 1.8rem; text-align: center; 
            text-transform: uppercase; border: 2px solid #5a6b5c; border-radius: 8px; margin-bottom: 15px;
        }
        button#btn-buscar { 
            width: 100%; padding: 18px; font-size: 1.2rem; background: #5a6b5c; 
            color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        #btn-notificar {
            background:#e67e22; margin-top: 15px; width:100%; padding:10px; 
            border:none; border-radius:8px; color:white; cursor:pointer; font-weight: bold;
        }
        #resultado { margin-top: 20px; width: 100%; max-width: 400px; display: none; }
        .agendado { background: #e3f2fd; color: #0d47a1; border: 1px solid #bbdefb; }
        .finalizado { background: #e8f5e9; color: #1b5e20; border: 1px solid #c8e6c9; }
        .piscando { 
            animation: pulse 1s infinite; background: #f1c40f; color: black; border: 2px solid #000;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <h1>AgendaCD</h1>
    <p>Consulte o status do seu agendamento</p>

    <div class="busca-container">
        <input type="text" id="placa-busca" placeholder="ABC1D23" maxlength="7">
        <button id="btn-buscar">VER MEU HOR√ÅRIO</button>
        <button id="btn-notificar">üîî RECEBER AVISO NO CELULAR</button>
    </div>

    <div id="resultado"></div>

    <script>
        const API_URL = "https://agenda-backend-production-5b72.up.railway.app/agendamentos";
        let monitoramentoAtivo = false;
        let jaNotificou = false; // TRAVA DE SEGURAN√áA

        // 1. Pedir permiss√£o
        document.getElementById('btn-notificar').addEventListener('click', () => {
            Notification.requestPermission().then(perm => {
                if (perm === 'granted') {
                    alert("√ìtimo! Voc√™ ser√° avisado quando for chamado.");
                    document.getElementById('btn-notificar').style.display = 'none';
                }
            });
        });

        // 2. Busca e Monitoramento
        document.getElementById('btn-buscar').addEventListener('click', async () => {
            const placa = document.getElementById('placa-busca').value.trim().toUpperCase();
            if (placa.length < 3) { alert("Digite a placa completa."); return; }

            buscarEExibir(placa);

            if (!monitoramentoAtivo) {
                monitoramentoAtivo = true;
                setInterval(() => buscarEExibir(placa), 10000); // Verifica a cada 10s
            }
        });

        async function buscarEExibir(placa) {
            const resDiv = document.getElementById('resultado');
            try {
                const response = await fetch(API_URL);
                const dados = await response.json();
                const hojeStr = new Date().toISOString().split("T")[0];

                const meusAgendamentos = dados.filter(a => 
                    a.placa.toUpperCase() === placa && a.data >= hojeStr
                );

                resDiv.style.display = "block";
                resDiv.innerHTML = ""; 

                if (meusAgendamentos.length > 0) {
                    meusAgendamentos.sort((a, b) => new Date(`${a.data} ${a.hora}`) - new Date(`${b.data} ${b.hora}`));

                    let htmlBase = `<h2>Resultados para ${placa}</h2>`;
                    
                    // L√≥gica da Notifica√ß√£o (Pega o primeiro da lista)
                    const principal = meusAgendamentos[0];
                    if (principal.status === "chamando") {
                        if (!jaNotificou) {
                            dispararNotificacao(principal.placa);
                            jaNotificou = true;
                        }
                    } else {
                        jaNotificou = false; // Libera para notificar se voltar a chamar
                    }

                    meusAgendamentos.forEach(item => {
                        const classeStatus = item.status === 'finalizado' ? 'finalizado' : (item.status === 'chamando' ? 'piscando' : 'agendado');
                        htmlBase += `
                            <div class="resultado-item ${classeStatus}" style="margin-bottom: 15px; padding: 15px; border-radius: 8px;">
                                <p>Hor√°rio: <span style="font-size: 1.5rem;">${item.hora}</span></p>
                                <p>Status: <strong>${item.status.toUpperCase()}</strong></p>
                            </div>
                        `;
                    });
                    resDiv.innerHTML = htmlBase;
                } else {
                    resDiv.innerHTML = "<p>Nenhum agendamento encontrado.</p>";
                }
            } catch (error) { console.error("Erro na consulta", error); }
        }
function dispararNotificacao(placa) {
    if ('vibrate' in navigator) {
        // Padr√£o: Vibra 1 segundo, pausa 0.2s, vibra 1 segundo, pausa 0.2s, vibra 2 segundos
        // Isso √© bem dif√≠cil de ignorar no bolso.
        navigator.vibrate([1000, 200, 1000, 200, 2000]);
    }

    if (Notification.permission === 'granted') {
        new Notification("‚ö†Ô∏è SUA VEZ CHEGOU!", {
            body: `Motorista da placa ${placa}, dirija-se √† √°rea de descarga.`,
            icon: "/icon-192.png",
            vibrate: [1000, 200, 1000, 200, 2000],
            tag: 'chamada-motorista', // Evita que acumule v√°rias notifica√ß√µes iguais
            renotify: true // Faz vibrar de novo se a notifica√ß√£o for atualizada
        });
    }
}
        // Registro do Service Worker para PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    </script>
</body>
</html>