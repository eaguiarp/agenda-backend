<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Painel Logístico - CD Itaboraí</title>

<style>
body {
    margin: 0;
    padding: 0;
    background: #121212;
    color: white;
    font-family: 'Segoe UI', sans-serif;
    height: 100vh;
    overflow: hidden;
}

.container {
    display: grid;
    height: 100vh;
    grid-template-columns: 60% 40%;
    grid-template-rows: 60% 40%;
    grid-template-areas:
        "principal fila"
        "inferior fila";
}

.area-principal {
    grid-area: principal;
    border-right: 2px solid #333;
    border-bottom: 2px solid #333;
    padding: 20px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.area-inferior {
    grid-area: inferior;
    display: flex;
    border-right: 2px solid #333;
}

.area-fila {
    grid-area: fila;
    background: #1e1e1e;
    padding: 20px;
}

.box-proximo, .box-historico {
    width: 50%;
    padding: 15px;
}

.box-proximo {
    border-right: 1px solid #333;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.box-historico {
    background: #0f2b15;
}

h2 {
    margin: 0 0 10px 0;
    color: #888;
    text-transform: uppercase;
    font-size: 1.2rem;
    letter-spacing: 2px;
}

.placa-gigante {
    font-size: 8rem;
    font-weight: bold;
}

.hora-gigante {
    font-size: 3rem;
    color: #f1c40f;
}

.placa-media {
    font-size: 4rem;
    font-weight: bold;
}

.hora-media {
    font-size: 2rem;
    color: #aaa;
}

.lista-fila div {
    background: #333;
    margin-bottom: 10px;
    padding: 15px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    font-size: 1.5rem;
}

.item-historico {
    font-size: 1rem;
    border-bottom: 1px solid #444;
    padding: 5px 0;
    display: flex;
    justify-content: space-between;
}

.status-badge {
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.8rem;
}

.bg-descarregando {
    background: #e67e22;
}

.bg-finalizado {
    background: #2ecc71;
    color: black;
}

.piscando {
    animation: piscar 0.8s infinite;
    background-color: #f1c40f;
    color: black;
    padding: 20px;
    border-radius: 10px;
}

@keyframes piscar {
    0% { opacity: 1; }
    50% { opacity: 0.7; transform: scale(1.02); }
    100% { opacity: 1; }
}
</style>
</head>

<body>

<div class="container">

   <div class="area-principal" id="painel-principal">
    <div id="tv-band" style="width:100%; height:100%;"></div>
</div>

    
    <div class="area-inferior">
        <div class="box-proximo" id="painel-proximo">
            <h2>Próximo Veículo</h2>
        </div>

        <div class="box-historico">
            <h2>Status Pátio</h2>
            <div id="painel-historico"></div>
        </div>
    </div>

    <div class="area-fila">
        <h2>Próximos da Fila</h2>
        <div class="lista-fila" id="painel-fila"></div>
    </div>

</div>

<audio id="som-alerta"
src="https://agenda-backend-production-5b72.up.railway.app/msn-wizz-sound.ogg?v=2">
</audio>

<script>
const API_URL = "https://agenda-backend-production-5b72.up.railway.app/agendamentos";
let ultimoChamadoID = null;
let contadorBips = 0;

async function atualizarTV() {
    try {
        const res = await fetch(API_URL);
        const dados = await res.json();

        const ativos = dados
            .filter(a => a.status !== "finalizado")
            .sort((a, b) =>
                new Date(`${a.data} ${a.hora}`) -
                new Date(`${b.data} ${b.hora}`)
            );

        // CHAMANDO
        const chamando = ativos.find(a => a.status === "chamando");
        const divPrincipal = document.getElementById("painel-principal");

        if (chamando) {
            divPrincipal.innerHTML = `
                <h2>CHAMANDO AGORA</h2>
                <div class="piscando">
                    <div class="placa-gigante">${chamando.placa}</div>
                    <div class="hora-gigante">${chamando.hora}</div>
                </div>
            `;

            if (ultimoChamadoID !== chamando.id) {
                ultimoChamadoID = chamando.id;
                contadorBips = 0;
                tocarSom();
                anunciarVeiculo(chamando.placa);
            }
        } else {
            if (ultimoChamadoID !== null) {
        divPrincipal.innerHTML = "";
        ultimoChamadoID = null;
        carregarBand();
        }
        }


        // PRÓXIMO
        const proximo = ativos.find(a => a.status === "agendado");
        const divProximo = document.getElementById("painel-proximo");

        if (proximo) {
            divProximo.innerHTML = `
                <h2>Próximo Veículo</h2>
                <div class="placa-media">${proximo.placa}</div>
                <div class="hora-media">${proximo.hora}</div>
            `;
        }

        // FILA
        const fila = ativos.filter(a => a.status === "agendado");
        const divFila = document.getElementById("painel-fila");

        divFila.innerHTML = fila.slice(0, 6).map(a => `
            <div>
                <span>${a.placa}</span>
                <span>${a.hora}</span>
            </div>
        `).join("");

        // HISTÓRICO
        const historico = dados
            .filter(a => a.status === "descarregando" || a.status === "finalizado")
            .slice(-6)
            .reverse();

        const divHistorico = document.getElementById("painel-historico");

        divHistorico.innerHTML = historico.map(a => `
            <div class="item-historico">
                <span>${a.placa}</span>
                <span class="status-badge ${a.status === 'descarregando' ? 'bg-descarregando' : 'bg-finalizado'}">
                    ${a.status}
                </span>
            </div>
        `).join("");

    } catch (e) {
        console.error("Erro TV", e);
    }
}

function tocarSom() {
    if (contadorBips < 3) {
        const audio = document.getElementById("som-alerta");
        audio.currentTime = 0;
        audio.play().catch(() => {});
        contadorBips++;
        setTimeout(tocarSom, 2500);
    }
}

function anunciarVeiculo(placa) {
    const placaFalada = placa.split('').join(' ');
    const texto = `Atenção motorista do veículo ${placaFalada}. Dirija-se à área de descarga.`;

    const fala = new SpeechSynthesisUtterance(texto);
    fala.lang = "pt-BR";
    fala.rate = 0.9;

    speechSynthesis.cancel();
    speechSynthesis.speak(fala);
}

document.body.addEventListener('click', () => {
    const audio = document.getElementById("som-alerta");
    audio.play();
    audio.pause();
    audio.currentTime = 0;
});

setInterval(atualizarTV, 5000);
atualizarTV();


async function carregarBand() {
    try {
        const res = await fetch("/bandnews-live");
        const data = await res.json();

        const container = document.getElementById("tv-band");

        if (data.videoId) {
            container.innerHTML = `
                <iframe 
                    width="100%" 
                    height="100%" 
                    src="https://www.youtube.com/embed/${data.videoId}?autoplay=1&mute=1"
                    frameborder="0"
                    allow="autoplay; encrypted-media"
                    allowfullscreen>
                </iframe>
            `;
        } else {
            container.innerHTML = "<p>BandNews não está ao vivo no momento.</p>";
        }

    } catch (error) {
        console.error("Erro ao carregar BandNews:", error);
    }
}

carregarBand();
setInterval(carregarBand, 60000);


</script>

</body>
</html>
