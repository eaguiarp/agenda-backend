<!DOCTYPE html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Painel Log√≠stico - CD Itabora√≠</title>
    <style>
        /* RESET E GRID */
        body { margin: 0; padding: 0; background: #121212; color: white; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        
        .container {
            display: grid;
            height: 100vh;
            grid-template-columns: 60% 40%;
            grid-template-rows: 60% 40%;
            grid-template-areas: 
                "principal fila"
                "inferior fila";
        }

        /* √ÅREAS */
        .area-principal { grid-area: principal; border-right: 2px solid #333; border-bottom: 2px solid #333; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .area-inferior { grid-area: inferior; display: flex; border-right: 2px solid #333; }
        .area-fila { grid-area: fila; background: #1e1e1e; padding: 20px; }

        /* SUB-DIVIS√ïES INFERIOR */
        .box-proximo { width: 50%; border-right: 1px solid #333; padding: 15px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .box-historico { width: 50%; background: #0f2b15; padding: 15px; }

        /* ESTILOS DE TEXTO */
        h2 { margin: 0 0 10px 0; color: #888; text-transform: uppercase; font-size: 1.2rem; letter-spacing: 2px; }
        .placa-gigante { font-size: 8rem; font-weight: bold; color: #fff; line-height: 1; }
        .hora-gigante { font-size: 3rem; color: #f1c40f; margin-top: 10px; }
        
        .placa-media { font-size: 4rem; font-weight: bold; }
        .hora-media { font-size: 2rem; color: #aaa; }

        /* LISTA LATERAL (FILA) */
        .lista-fila div {
            background: #333;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.5rem;
        }
        .lista-fila div span:last-child { color: #f1c40f; font-weight: bold; }

        /* HIST√ìRICO (CARREGANDO) */
        .item-historico {
            font-size: 1.1rem; color: #bbb; border-bottom: 1px solid #444; padding: 5px 0; display: flex; justify-content: space-between;
        }
        .status-badge { font-size: 0.8rem; padding: 2px 5px; border-radius: 4px; }
        .bg-carregando { background: #e67e22; color: white; }
        .bg-finalizado { background: #2ecc71; color: black; }

        /* ANIMA√á√ÉO CHAMANDO */
        .piscando { animation: piscar 0.8s infinite; background-color: #f1c40f; color: black; padding: 20px; border-radius: 10px; width: 90%; text-align: center; }
        @keyframes piscar { 0% { opacity: 1; } 50% { opacity: 0.7; transform: scale(1.02); } 100% { opacity: 1; } }

        /* RODAP√â DO BLOCO */
        .aviso-sonoro { position: absolute; bottom: 10px; left: 10px; font-size: 0.8rem; color: #555; }
    </style>
</head>
<body>

    <div class="container">
        <div class="area-principal" id="painel-principal">
            <h2>Chamando Agora</h2>
            <div class="placeholder">Aguardando chamada...</div>
            <div class="aviso-sonoro">üîä Clique na tela para ativar o som</div>
        </div>

        <div class="area-inferior">
            <div class="box-proximo" id="painel-proximo">
                <h2>Pr√≥ximo Ve√≠culo</h2>
                </div>
            <div class="box-historico">
                <h2>Status P√°tio</h2>
                <div id="painel-historico"></div>
            </div>
        </div>

        <div class="area-fila">
            <h2>Pr√≥ximos da Fila</h2>
            <div class="lista-fila" id="painel-fila"></div>
        </div>
    </div>

    <audio id="som-alerta" src="https://agenda-backend-production-5b72.up.railway.app/msn-wizz-sound.ogg?v=2"
></audio>

    <script>
        const API_URL = "https://agenda-backend-production-5b72.up.railway.app/agendamentos";
        let ultimoChamadoID = null;
        let contadorBips = 0;

        async function atualizarTV() {
            try {
                const res = await fetch(API_URL);
                const dados = await res.json();
                
                // Filtra quem n√£o foi finalizado
                // Ordena por hora
                const ativos = dados.filter(a => a.status !== "finalizado")
                                    .sort((a, b) => new Date(`${a.data} ${a.hora}`) - new Date(`${b.data} ${b.hora}`));

                // 1. L√≥gica do CHAMANDO (Principal)
                const chamando = ativos.find(a => a.status === "chamando");
                const divPrincipal = document.getElementById("painel-principal");
                
              if (chamando) {
                    divPrincipal.innerHTML = `
                        <h2>CHAMANDO AGORA</h2>
                        <div class="piscando">
                            <div class="placa-gigante">${chamando.placa}</div>
                            <div class="hora-gigante">${chamando.hora}</div>
                            
    
                          <div style="
    display: flex;
    flex-direction: column;
    gap: 25px;
    font-weight: bold;
    text-align: center;
">

    <div>
        DESLIGUE O MOTOR ‚Ä¢ CALCE AS RODAS ‚Ä¢ ENTREGUE AS CHAVES
    </div>

   <div style="
    font-size: 1.6rem;
    font-weight: 900;
    letter-spacing: 1px;
">
    USO OBRIGAT√ìRIO DE EPIs
</div>

</div>
                        </div>
                    `;


                    // L√≥gica do Som (Toca 3 vezes e para)
                    if (ultimoChamadoID !== chamando.id) {
                        ultimoChamadoID = chamando.id;
                        contadorBips = 0; // Reseta contador
                        tocarSom();
                    }
                } else {
                    divPrincipal.innerHTML = `<h2>Aguardando Chamada</h2><div style="color: #444; font-size: 2rem;">--</div>`;
                }

                // 2. L√≥gica do PR√ìXIMO (O primeiro 'agendado' da lista)
                const proximo = ativos.find(a => a.status === "agendado");
                const divProximo = document.getElementById("painel-proximo");
                if (proximo) {
                    divProximo.innerHTML = `
                        <h2>Pr√≥ximo Ve√≠culo</h2>
                        <div class="placa-media">${proximo.placa}</div>
                        <div class="hora-media">${proximo.hora}</div>
                    `;
                } else {
                    divProximo.innerHTML = `<h2>Pr√≥ximo</h2><p>--</p>`;
                }

                // 3. L√≥gica da FILA (Pega os pr√≥ximos 4 agendados, pulando o que j√° √© "Pr√≥ximo")
                const fila = ativos.filter(a => a.status === "agendado" && a.id !== (proximo ? proximo.id : null)).slice(0, 5);
                const divFila = document.getElementById("painel-fila");
                divFila.innerHTML = "";
                fila.forEach(item => {
                    divFila.innerHTML += `
                        <div>
                            <span>${item.placa}</span>
                            <span>${item.hora}</span>
                        </div>
                    `;
                });

                // 4. L√≥gica do HIST√ìRICO (Carregando + √öltimos Finalizados)
                // Para pegar finalizados, precisamos filtrar do "dados" original
                const carregando = dados.filter(a => a.status === "carregando");
                const ultimosFinalizados = dados.filter(a => a.status === "finalizado")
                                                .sort((a, b) => new Date(b.id) - new Date(a.id)) // Mais recentes primeiro (baseado no ID timestamp)
                                                .slice(0, 3);
                
                const divHist = document.getElementById("painel-historico");
                divHist.innerHTML = "";
                
                // Mostra quem est√° carregando
                carregando.forEach(item => {
                    divHist.innerHTML += `
                        <div class="item-historico">
                            <span>${item.placa}</span>
                            <span class="status-badge bg-carregando">DESCARREGANDO</span>
                        </div>
                    `;
                });
                
                // Mostra √∫ltimos finalizados
                ultimosFinalizados.forEach(item => {
                    divHist.innerHTML += `
                        <div class="item-historico">
                            <span>${item.placa}</span>
                            <span class="status-badge bg-finalizado">FINALIZADO</span>
                        </div>
                    `;
                });

            } catch (e) { console.error("Erro TV", e); }
        }

        function tocarSom() {
            if (contadorBips < 3) {
                const audio = document.getElementById("som-alerta");
                audio.play().catch(e => console.log("Clique na tela para habilitar som"));
                contadorBips++;
                setTimeout(tocarSom, 2500); // Repete a cada 2.5 segundos
            }
        }

        // Habilita som no primeiro clique
        document.body.addEventListener('click', () => {
            const audio = document.getElementById("som-alerta");
            audio.play();
            audio.pause();
            audio.currentTime = 0;
        });

        setInterval(atualizarTV, 5000); // Atualiza a cada 5 segundos
        atualizarTV();
    </script>
</body>
</html>